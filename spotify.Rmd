----
   title: "Favorite Spotify Songs Attributes"
   author: "Joel Soroos"
   date: "April 4, 2020"
   output: pdf_document
---


### Motivation
Spotify is an amazing tool to play favorite music, as well as discover new music or rediscover old favorites.  The API in turn provides free access to a wide array of statistics on songs and albums in playlists.

### 1. Activate Spotify connection
First step is to sign up for a [free Spotify API developer ID and secret token](https://developer.spotify.com/).

Second, you can either embed the Spotify login information directly in the script or assign to an enivronment variable.  The advantage of an environment variable is your private login information will be stored on your computer.  That way your R code can be shared without exposure to your login information being stolen.  The [usethis package](https://community.rstudio.com/t/how-to-set-a-variable-in-renviron/5029/4) simplifies creating and updating environment variables. 
```{r activate, warning = TRUE, results = FALSE, message = FALSE}

   library (spotifyr)

   access_token <- get_spotify_access_token(
      client_id=Sys.getenv("SPOTIFY_CLIENT_ID"),
      client_secret=Sys.getenv("SPOTIFY_CLIENT_SECRET")
      )
```


### 2. Source favorite tracks
I decided to focus my analysis on liked tracks (called "favorites" in the Spotify API).  The favorite_tracks function extracts information such as song name, album name and artist(s).

Spotify limits the number of tracks per call to 50, much less than my 200 likes.  A [clever workaround by Han Chen](https://rpubs.com/womeimingzi11/how_my_spotify_looks_like) is to extract multiple tranches of 50 songs the purrr map function.  

The favorite_tracks function returns the output in an unwieldy list format that requires simplification to the more manageable data frame.  The artist name creates multiple records per song because multiple artists can be assigned to individual songs.  I simplified by unnesting the list so multiple rows per song for each artist.  The distinct function helped me consolidate to a unique a list of songs.
```{r source, warning = TRUE, results = FALSE, message = FALSE}

   library (tidyverse)

   #source favorite tracks - default is listed twice if multiple artists
      #code chunk in this section sourced from: https://rpubs.com/womeimingzi11/how_my_spotify_looks_like
   favorite_tracks <-
        ceiling(get_my_saved_tracks(include_meta_info = TRUE)[['total']] / 50) %>%
        seq() %>%
        map(function(x) {           #circumvents 50 track limit from Spotify
          get_my_saved_tracks(
             limit = 50,
             offset = (x - 1) * 50)
            }) %>% 
        reduce (rbind) %>%
        unnest (track.artists)      #simplifies list to multiple rows for tracks with two artists
   
   #remove duplicate tracks by including first named artist only
      favorite_tracks_ids<- favorite_tracks %>%
         distinct (track.id) %>%       #eliminates duplicate rows by songs with > 1 artist (picks 1st)
         pull (track.id)            
```


### 3. Add audio features to favorite tracks
```{r warning = TRUE, results = FALSE, message = FALSE}

   #Definitions: #https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-01-21/readme.md
   
   library (lubridate)
   
   favorite_tracks_features <- 
      seq (1, nrow(favorite_tracks),100) %>%
      map(function(x) {
          get_track_audio_features (favorite_tracks_ids[x:(x+99)])   #circumvents max of 100 track IDs
            }) %>%
      reduce(rbind) %>%             #simplifies list and appends previously nested frames
      drop_na() %>%                 #removes N/As resulting from liked song totals less than 100 multiple
      right_join(favorite_tracks, by = c("id" = "track.id")) %>%
      rename (artist.name = name) %>%
      mutate (
         duration = duration_ms / 1000 / 60,                      #converts milliseconds to minutes
         track.name = str_remove (track.name, c("Remaster", "Remastered")),
         track.name = str_remove (track.name,"[(-].+"),          #removes parentheticals in titles
         track.name = ifelse (str_length (track.name) <= 22, track.name, str_extract(track.name, "^.{22}")),
         release = ifelse (
            track.album.release_date_precision == "year",         #some songs only lists years not dates
            as.integer(track.album.release_date),
            year(as_date(track.album.release_date))
            ),
         release = release - 1980                            #enables bar charts to start at 0
         ) %>%
      select (artist.name, track.name, danceability, energy, valence, tempo, duration, release) %>%
      distinct (track.name, .keep_all = T)
```


4.  Visualize function
```{r warning = TRUE, results = FALSE, message = FALSE}

   library (glue)

   #function to create bar chart for dynamic variable
      attributes_plot = function(attribute = "tempo") {
         attribute = ensym (attribute)
         ggplot (
               data = favorite_tracks_features %>%
                  arrange (-!!attribute) %>%
                  slice (1:5, (n()-4):n()) %>%
                  mutate (bar_color = ifelse (!!attribute > median (!!attribute), "Lightgreen", "Red")),
               aes (x = reorder (track.name, !!attribute), y = !!attribute), 
               size = 1
               ) +
            geom_point (
               aes(color = I(bar_color)),
               shape = 19
               ) + 
            geom_segment (
               aes(
                  xend = reorder (track.name, !!attribute), y = 0, yend = !!attribute,
                  color = I(bar_color)
                  )
               ) + 
            geom_rug (
               data = favorite_tracks_features,
               aes (y = !!attribute),
               inherit.aes = F,
               sides = "l",
               alpha = 0.3
               ) +
            scale_y_continuous (n.breaks = 4) +
            coord_flip () +
            theme(
               plot.title = element_text(hjust = 0.5, vjust = 0, size = 10, face = "bold", margin = margin (10,0,10,0)),
               axis.text = element_text (size = 8),
               axis.title = element_blank(),
               axis.ticks = element_blank(),
               panel.grid = element_blank(),
               panel.background = element_blank()
               ) +
          labs (
             title = glue({str_to_title(attribute)})
             )
    }
```


#5.  Create and combine charts
```{r warning = TRUE, results = FALSE, message = FALSE}
  
   library (patchwork)

   #define variables to parse charts
      attributes <- c("valence", "energy", "tempo", "danceability", "duration", "release")

   #create charts for each attribute
      song_plots <- map(attributes, attributes_plot)
   
   #combine charts into grid
      song_plots_combine <- 
         song_plots[[1]] + song_plots[[2]]+ song_plots[[3]]+ song_plots[[4]]+ song_plots[[5]]+ song_plots[[6]] +
         plot_annotation (
            title =  "My favorite Spotify songs' attributes",
            subtitle = "Largest 5 per attribute in green, smallest 5 in red.  Bottom rug is entire distribution.",
            caption = "Duration = song length in minutes.  Release = number of years since 1980.  \nVisualization: Joel Soroos @soroosj    |    Data: Spotify API",
            theme = theme (
               plot.title = element_text(hjust = 0.5, vjust = 0, size = 15, face = "bold", margin = margin (0,0,5,0)),
               plot.title.position = "plot",
               plot.subtitle = element_text(hjust = 0.5, vjust = 0, size = 9, margin = margin (0,0,15,0)),
               plot.caption = element_text (hjust = 0, size = 8, face = "plain", margin = margin (15,0,0,0)),
               plot.caption.position = "plot")
               )
   
   #save chart grid to file
      ggsave("song_attributes.png", song_plots_combine)
```