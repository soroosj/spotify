----
   title: "Spotify"
   author: "Joel Soroos"
   date: "March 31, 2020"
   output: pdf_document
---


### 1. activate Spotify connection
```{r source, warning = TRUE, results = FALSE, message = FALSE}

   library (spotifyr)

   access_token <- get_spotify_access_token(
      client_id=Sys.getenv("SPOTIFY_CLIENT_ID"),
      client_secret=Sys.getenv("SPOTIFY_CLIENT_SECRET")
      )
```


### 2. source favorite tracks
```{r source, warning = TRUE, results = FALSE, message = FALSE}

   library (tidyverse)

   #source favorite tracks - default is listed twice if multiple artists
   favorite_tracks <-
     ceiling(get_my_saved_tracks(include_meta_info = TRUE)[['total']] / 50) %>%
     seq() %>%
     map(function(x) {
       get_my_saved_tracks(
          limit = 50, offset = (x - 1) * 50)
         }) %>% 
     reduce (rbind) %>%
     unnest (track.artists)
   
   #remove duplicate tracks by including first named artist only
      favorite_tracks_unique <- favorite_tracks %>%
         distinct (track.id) %>%
         pull (track.id)
```


### 3. add audio features to favorite tracks
```{r}

   #Definitions: #https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-01-21/readme.md
   
   favorite_tracks_features <-get_track_audio_features (favorite_tracks_unique) %>%
   
      right_join(favorite_tracks, by = c("id" = "track.id")) %>%
      rename (
         artist.name = name,
         popularity = track.popularity
         ) %>%
      mutate (
         duration = duration_ms / 1000 / 60,
         country = str_extract(track.external_ids.isrc, "^.{2}"),
         track.name = str_remove_all (track.name, "Remaster"),
         track.name = str_remove (track.name,"Remastered"),
         track.name = ifelse (str_length (track.name) <= 20, track.name, str_extract(track.name, "^.{20}"))
         ) %>%
      select (artist.name, track.name, danceability, energy, valence, tempo, popularity, duration, country) %>%
      distinct (track.name, .keep_all = T)
```


4.  Visualize function
```{r warning = TRUE, results = FALSE, message = FALSE}

   library (glue)

   #function to create bar chart for dynamic variable
   attributes_plot = function(attribute = tempo) {
      attribute = ensym (attribute)
      ggplot (
            data = favorite_tracks_features %>%
               arrange (-!!attribute) %>%
               slice (1:5, (n()-4):n()) %>%
               mutate (bar_color = ifelse (!!attribute > median (!!attribute), "Darkgreen", "Red")),
            aes (x = reorder (track.name, !!attribute), y = !!attribute), 
            size = 1
            ) +
         geom_col (aes(fill = I(bar_color))) + 
         scale_y_continuous (n.breaks = 4) +
         coord_flip () +
         theme(
            plot.title = element_text(hjust = 0.5, size = 10, face = "bold", color = "black"),
            axis.text = element_text (size = 8),
            axis.title = element_blank(),
            panel.grid = element_blank(),
            panel.background = element_blank()
            ) +
       labs (title = glue({str_to_title(attribute)}))
    }
```


#5.  Create and combine charts
```{r warning = TRUE, results = FALSE, message = FALSE}
  
   library (patchwork)

   #define variables to parse charts
      attributes <- c("valence", "energy", "tempo", "danceability", "duration", "popularity")

   #create charts for each attribute
      song_plots <- map(attributes, attributes_plot)
   
   #combine charts into grid
      song_plots_combine <- 
         song_plots[[1]] + song_plots[[2]]+ song_plots[[3]]+ song_plots[[4]]+ song_plots[[5]]+ song_plots[[6]] +
         plot_annotation (
            title =  "Attributes of my favorite songs on Spotify",
            caption = "Visualization: Joel Soroos @soroosj  |  Data: Spotify API",
            theme =
               theme (
                  plot.title = element_text(hjust = 0.5, vjust = 0, size = 15, face = "bold", margin = margin (0,0,20,0)),
                  plot.title.position = "plot",
                  plot.caption = element_text (hjust = 1, size = 8, face = "plain", margin = margin (20,0,0,0)),
                  plot.caption.position = "plot")
                  )
   
   ggsave("song_attributes.png", song_plots_combine)
```